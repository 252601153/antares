# Antares æ•°æ®åº“è¿æ¥æµç¨‹åˆ†æ

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†åœ¨ Antares å®¢æˆ·ç«¯ä¸­ç‚¹å‡»â€œè¿æ¥â€æŒ‰é’®åçš„å†…éƒ¨æ‰§è¡Œæµç¨‹ï¼Œæ¶µç›–ä»å‰ç«¯ UI è§¦å‘åˆ°åç«¯æ•°æ®åº“äº¤äº’çš„å…¨è¿‡ç¨‹ã€‚

## ğŸ“Š æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant UI as ğŸ–¥ï¸ ç•Œé¢ (Vueç»„ä»¶)
    participant Store as ğŸ“¦ çŠ¶æ€ç®¡ç† (Pinia Store)
    participant IPC as ğŸŒ‰ IPC é€šä¿¡æ¡¥æ¢
    participant Main as âš™ï¸ ä¸»è¿›ç¨‹ (Electron)
    participant Client as ğŸ”Œ æ•°æ®åº“å®¢æˆ·ç«¯ (MySQLClient)
    participant DB as ğŸ—„ï¸ çœŸå®æ•°æ®åº“

    Note over UI, Store: 1. ç”¨æˆ·ç‚¹å‡»è¿æ¥
    UI->>Store: è°ƒç”¨ connectWorkspace()
    Store->>Store: è®¾ç½®çŠ¶æ€ä¸º "connecting"
    Store->>IPC: è°ƒç”¨ Connection.connect(params)
    IPC->>Main: å‘é€ 'connect' æ¶ˆæ¯

    Note over Main, DB: 2. ä¸»è¿›ç¨‹å»ºç«‹è¿æ¥
    Main->>Client: åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ (ClientsFactory)
    Main->>Client: è°ƒç”¨ client.connect()
    Client->>DB: å»ºç«‹ TCP/Socket è¿æ¥
    DB-->>Client: è¿æ¥æˆåŠŸ

    Note over Main, DB: 3. è·å–å…ƒæ•°æ® (æ ¸å¿ƒæ­¥éª¤)
    Main->>Client: è°ƒç”¨ client.getStructure()
    Client->>DB: SHOW DATABASES
    Client->>DB: SHOW FULL TABLES
    Client->>DB: SHOW FUNCTIONS/PROCEDURES...
    DB-->>Client: è¿”å›å…ƒæ•°æ®
    Client-->>Main: ç»„è£…æˆ JSON ç»“æ„ (WorkspaceStructure)

    Note over Main, Store: 4. è¿”å›æ•°æ®ä¸æ¸²æŸ“
    Main-->>IPC: è¿”å› { status: 'success', response: structure }
    IPC-->>Store: æ¥æ”¶æ•°æ®
    Store->>Store: è®¾ç½®çŠ¶æ€ "connected"
    Store->>Store: æ›´æ–° workspace.structure
    Store-->>UI: æ•°æ®å˜æ›´è§¦å‘å“åº”å¼æ›´æ–°
    UI->>UI: æ¸²æŸ“ä¾§è¾¹æ æ ‘å½¢ç»“æ„
```

## ğŸ“ è¯¦ç»†æ­¥éª¤è§£æ

### 1. å‰ç«¯è§¦å‘ (Renderer Process)
*   **æ–‡ä»¶**: `src/renderer/stores/workspaces.ts`
*   **åŠ¨ä½œ**: ç”¨æˆ·ç‚¹å‡»è¿æ¥åï¼Œè§¦å‘ `workspace` store ä¸­çš„ `connectWorkspace` æ–¹æ³•ã€‚
*   **é€»è¾‘**:
    *   å°†å½“å‰å·¥ä½œåŒºè¿æ¥çŠ¶æ€æ ‡è®°ä¸º `connecting`ï¼ˆç•Œé¢æ˜¾ç¤ºåŠ è½½è½¬åœˆï¼‰ã€‚
    *   å‡†å¤‡è¿æ¥å‚æ•°ï¼ˆä¸»æœºã€ç«¯å£ã€ç”¨æˆ·ã€å¯†ç ç­‰ï¼‰ã€‚
    *   é€šè¿‡ `Connection.connect` å‘èµ·å¼‚æ­¥è¯·æ±‚ã€‚

### 2. IPC é€šä¿¡æ¡¥æ¢
*   **æ–‡ä»¶**: `src/renderer/ipc-api/Connection.ts`
*   **åŠ¨ä½œ**: æ¸²æŸ“è¿›ç¨‹é€šè¿‡ Electron çš„ `ipcRenderer.invoke('connect', params)` å‘ä¸»è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚
*   **ä½œç”¨**: è¿™æ˜¯å‰ç«¯ UI ä¸åç«¯ Node.js èƒ½åŠ›çš„è¾¹ç•Œã€‚

### 3. ä¸»è¿›ç¨‹å¤„ç† (Main Process)
*   **æ–‡ä»¶**: `src/main/ipc-handlers/connection.ts`
*   **ç›‘å¬**: ä¸»è¿›ç¨‹ç›‘å¬åˆ° `connect` äº‹ä»¶ã€‚
*   **é€»è¾‘**:
    *   **éªŒè¯**: æ£€æŸ¥è¯·æ±‚æ¥æºæ˜¯å¦åˆæ³•ã€‚
    *   **å·¥å‚æ¨¡å¼**: ä½¿ç”¨ `ClientsFactory` æ ¹æ®æ•°æ®åº“ç±»å‹ï¼ˆå¦‚ MySQLï¼‰åˆ›å»ºå¯¹åº”çš„å®¢æˆ·ç«¯å®ä¾‹ã€‚
    *   **æ‰§è¡Œ**: è°ƒç”¨å®¢æˆ·ç«¯å®ä¾‹çš„ `connect()` å’Œ `getStructure()` æ–¹æ³•ã€‚

### 4. æ•°æ®åº“äº¤äº’ä¸å…ƒæ•°æ®æå– (MySQL Client)
è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå†³å®šäº†ä½ çœ‹åˆ°ä»€ä¹ˆä¿¡æ¯ã€‚
*   **æ–‡ä»¶**: `src/main/libs/clients/MySQLClient.ts`
*   **æ–¹æ³•**: `getStructure(schemas)`
*   **æ‰§è¡Œçš„ SQL æŸ¥è¯¢**:
    1.  **è·å–æ•°æ®åº“åˆ—è¡¨**: `SHOW DATABASES`
    2.  **è·å–å‡½æ•°/è¿‡ç¨‹**: `SHOW FUNCTION STATUS`, `SHOW PROCEDURE STATUS`
    3.  **è·å–è§¦å‘å™¨**: `SHOW TRIGGERS`
    4.  **è·å–è¡¨å’Œè§†å›¾**: éå†æ¯ä¸ªæ•°æ®åº“ï¼Œæ‰§è¡Œ `SHOW FULL TABLES FROM <db_name>`
    5.  **è·å–è°ƒåº¦å™¨**: æŸ¥è¯¢ `information_schema.EVENTS`

    > **æ³¨æ„**: è¿™ä¸€æ­¥ä¼šæŠŠæ‰€æœ‰æŸ¥åˆ°çš„æ•°æ®ç»„è£…æˆä¸€ä¸ªå·¨å¤§çš„ JSON å¯¹è±¡ï¼ŒåŒ…å«æ•°æ®åº“åã€è¡¨ååˆ—è¡¨ã€å¯¹è±¡ç±»å‹ç­‰ï¼Œä½†**ä¸åŒ…å«**è¡¨å†…çš„å…·ä½“æ•°æ®ï¼ˆè¡Œè®°å½•ï¼‰ã€‚

### 5. æ•°æ®è¿”å›ä¸ UI æ¸²æŸ“
*   **æ•°æ®æµå›**: å·¨å¤§çš„ JSON å¯¹è±¡ï¼ˆ`structure`ï¼‰é€šè¿‡ IPC è¿”å›ç»™å‰ç«¯ Storeã€‚
*   **çŠ¶æ€æ›´æ–°**:
    *   `workspaces.ts` å°† workspace çš„çŠ¶æ€æ”¹ä¸º `connected`ã€‚
    *   å°†è·å–åˆ°çš„ JSON èµ‹å€¼ç»™ `workspace.structure`ã€‚
*   **ç•Œé¢æ¸²æŸ“**:
    *   **æ–‡ä»¶**: `src/renderer/components/WorkspaceExploreBar.vue`
    *   è¿™æ˜¯ä¸€ä¸ª Vue ç»„ä»¶ï¼Œå®ƒç›‘å¬ `structure` æ•°æ®çš„å˜åŒ–ã€‚
    *   ä½¿ç”¨ `v-for` å¾ªç¯éå†æ•°æ®ï¼Œåœ¨å·¦ä¾§ä¾§è¾¹æ æ¸²æŸ“å‡ºæ•°æ®åº“ -> è¡¨/è§†å›¾/å‡½æ•° çš„æ ‘å½¢ç»“æ„ã€‚

## ğŸ“‚ æ ¸å¿ƒæ•°æ®ç»“æ„

å‰ç«¯æ‹¿åˆ°çš„æ•°æ®ç»“æ„ (`WorkspaceStructure`) ç¤ºä¾‹ï¼š

```json
[
  {
    "name": "my_database",
    "size": 102400,
    "tables": [
      { "name": "users", "type": "table", "rows": 100 },
      { "name": "orders", "type": "table", "rows": 50 }
    ],
    "functions": [],
    "procedures": [],
    "triggers": [],
    "schedulers": []
  },
  {
    "name": "another_db",
    ...
  }
]
```
